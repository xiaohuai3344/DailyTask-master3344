# 远程指令系统设计文档

## 📱 设计目标

通过微信/企业微信/QQ等辅助应用的通知，向主应用发送指令，实现远程控制和管理功能。

## 🎯 指令分类与优先级

### 1. 任务控制类（HIGH Priority）
- ✅ **启动**：启动日常打卡任务
- ✅ **停止**：停止日常打卡任务
- ✅ **重试打卡**：远程触发重新打卡
- 🆕 **添加任务**：远程添加新的打卡时间点
- 🆕 **修改任务**：远程修改现有任务时间
- 🆕 **删除任务**：远程删除指定任务
- 🆕 **查询任务**：查看所有已配置的任务

### 2. 系统管理类（MEDIUM Priority）
- ✅ **开始循环**：启用任务自动启动
- ✅ **暂停循环**：禁用任务自动启动
- 🆕 **重启应用**：远程重启主应用
- 🆕 **清理缓存**：清理应用缓存和日志
- 🆕 **修改超时时间**：调整打卡超时时长
- 🆕 **查询配置**：查看当前系统配置

### 3. 状态查询类（LOW Priority）
- ✅ **电量**：查询手机剩余电量
- ✅ **考勤记录**：查询当天考勤记录
- 🆕 **应用状态**：查询应用运行状态
- 🆕 **日志查询**：查询最近的日志记录
- 🆕 **版本信息**：查询当前版本号

### 4. 显示控制类（LOW Priority）
- ✅ **息屏**：显示伪灭屏遮罩
- ✅ **亮屏**：隐藏伪灭屏遮罩
- 🆕 **延迟息屏**：指定秒数后自动息屏

## 📋 指令格式设计

### 基础格式
```
格式1（推荐）：指令:<command> [参数1] [参数2] ...
格式2（兼容）：#<command> [参数1] [参数2] ...
格式3（精确）：<command> [参数1] [参数2] ...（仅限无参数或单关键词指令）
```

### 指令示例

#### 1. 任务控制类
```
# 启动/停止
指令:启动
指令:停止

# 重试打卡
指令:重试打卡

# 添加任务（格式：HH:mm）
指令:添加任务 09:00
指令:添加任务 18:00

# 修改任务（格式：旧时间->新时间）
指令:修改任务 09:00 09:15
#修改任务 18:00->18:30

# 删除任务
指令:删除任务 09:00

# 查询所有任务
指令:查询任务
#任务列表
```

#### 2. 系统管理类
```
# 循环控制
指令:开始循环
指令:暂停循环

# 重启应用
指令:重启应用
#重启

# 清理缓存
指令:清理缓存

# 修改超时时间（秒）
指令:修改超时 45
指令:修改超时 60

# 查询配置
指令:查询配置
#配置信息
```

#### 3. 状态查询类
```
# 电量查询
指令:电量
#电量

# 考勤记录
指令:考勤记录
#考勤

# 应用状态
指令:应用状态
#状态

# 日志查询（最近N条，默认10条）
指令:日志查询
指令:日志查询 20

# 版本信息
指令:版本信息
#版本
```

#### 4. 显示控制类
```
# 息屏/亮屏
指令:息屏
指令:亮屏

# 延迟息屏（秒）
指令:延迟息屏 10
```

## 🔒 安全机制

### 1. 指令验证
- 严格的指令格式校验
- 参数类型和范围检查
- 防止SQL注入和命令注入

### 2. 来源验证
- 仅允许配置的辅助应用发送指令
- 记录所有指令来源和执行时间

### 3. 频率限制
- 同一指令60秒内只能执行一次
- 敏感操作（重启、清理）需要二次确认
- 防止指令洪泛攻击

### 4. 授权管理
- 可选择性启用/禁用某些指令类别
- 支持指令黑名单和白名单

## 📊 指令执行流程

```
1. 接收通知
   ↓
2. 提取指令内容
   ↓
3. 解析指令和参数
   ↓
4. 验证指令格式
   ↓
5. 检查执行权限
   ↓
6. 检查频率限制
   ↓
7. 执行指令操作
   ↓
8. 记录执行日志
   ↓
9. 发送确认邮件
```

## 🛡️ 错误处理

### 错误类型
1. **格式错误**：指令格式不正确
2. **参数错误**：参数数量或类型不匹配
3. **权限错误**：指令被禁用或不允许执行
4. **频率错误**：执行过于频繁
5. **执行错误**：指令执行失败

### 错误响应
- 发送详细的错误信息邮件
- 记录错误日志
- 提供正确的指令格式示例

## 📈 优先级实施计划

### Phase 1: 任务管理核心指令（本次实现）
- 添加任务
- 修改任务
- 删除任务
- 查询任务
- 重启应用
- 查询配置

### Phase 2: 系统管理增强（下个版本）
- 清理缓存
- 日志查询
- 应用状态监控

### Phase 3: 高级功能（未来版本）
- 指令权限管理
- 指令执行历史
- 批量操作支持

## 🎨 用户体验优化

### 1. 智能提示
- 指令不匹配时提供最相似的指令建议
- 参数错误时提供正确的格式示例

### 2. 操作确认
- 所有指令执行后发送确认邮件
- 包含执行结果和相关信息

### 3. 帮助文档
- 新增"帮助"指令，返回所有可用指令列表
- 新增"示例"指令，返回常用指令示例

### 4. 快捷指令
- 支持指令别名（如：start/启动、stop/停止）
- 支持英文指令（便于自动化脚本调用）

## 📝 实现注意事项

1. **向后兼容**：保持现有指令不变
2. **性能优化**：避免阻塞主线程
3. **异常处理**：完善的try-catch覆盖
4. **日志记录**：记录所有指令执行详情
5. **邮件通知**：统一的邮件发送格式

## 🔄 版本更新计划

- **v3.0.4**：实现Phase 1核心指令
- **v3.1.0**：实现Phase 2系统管理
- **v3.2.0**：实现Phase 3高级功能

---

**文档版本**: v1.0  
**创建日期**: 2026-02-06  
**最后更新**: 2026-02-06
