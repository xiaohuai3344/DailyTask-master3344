name: Build Android APK

on:
  push:
    branches:
      - master
      - genspark_ai_developer
  pull_request:
    branches:
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace
      
    - name: Build Release APK
      run: ./gradlew assembleRelease --stacktrace
      
    - name: Get version info
      id: version
      run: |
        # æå–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¤„ç†å•å¼•å·å’ŒåŒå¼•å·ï¼‰
        VERSION_NAME=$(grep "versionName" app/build.gradle | awk '{print $2}' | tr -d "'" | tr -d '"')
        VERSION_CODE=$(grep "versionCode" app/build.gradle | awk '{print $2}')
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date +'%Y%m%d_%H%M%S')
        
        # éªŒè¯æå–çš„å€¼ä¸ä¸ºç©º
        if [ -z "$VERSION_NAME" ]; then
          VERSION_NAME="2.2.5.1"
          echo "Warning: Could not extract versionName, using default: $VERSION_NAME"
        fi
        if [ -z "$VERSION_CODE" ]; then
          VERSION_CODE="2251"
          echo "Warning: Could not extract versionCode, using default: $VERSION_CODE"
        fi
        
        # è¾“å‡ºåˆ° GitHub Actions
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        
        # æ‰“å°è°ƒè¯•ä¿¡æ¯
        echo "Version Name: $VERSION_NAME"
        echo "Version Code: $VERSION_CODE"
        echo "Commit: $COMMIT_SHORT"
        echo "Build Date: $BUILD_DATE"
        
    - name: Rename APK files
      run: |
        # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„ APK æ–‡ä»¶
        echo "=== Debug APK files ==="
        ls -lh app/build/outputs/apk/debug/ || echo "Debug directory not found"
        echo "=== Release APK files ==="
        ls -lh app/build/outputs/apk/release/ || echo "Release directory not found"
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p apk_output
        
        # å¤åˆ¶å¹¶é‡å‘½å Debug APKï¼ˆæ”¯æŒå¤šç§æ–‡ä»¶åæ ¼å¼ï¼‰
        DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" -type f | head -n 1)
        if [ -n "$DEBUG_APK" ]; then
          cp "$DEBUG_APK" "apk_output/DailyTask_${{ steps.version.outputs.version_name }}_debug_${{ steps.version.outputs.build_date }}.apk"
          echo "Debug APK copied: $DEBUG_APK"
        else
          echo "Warning: Debug APK not found"
        fi
        
        # å¤åˆ¶å¹¶é‡å‘½å Release APKï¼ˆæ”¯æŒå¤šç§æ–‡ä»¶åæ ¼å¼ï¼‰
        RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -n 1)
        if [ -n "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" "apk_output/DailyTask_${{ steps.version.outputs.version_name }}_release_unsigned_${{ steps.version.outputs.build_date }}.apk"
          echo "Release APK copied: $RELEASE_APK"
        else
          echo "Warning: Release APK not found"
        fi
        
        # æ˜¾ç¤ºæœ€ç»ˆè¾“å‡º
        echo "=== Final APK files ==="
        ls -lh apk_output/
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: DailyTask-debug-${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.commit_short }}
        path: apk_output/*debug*.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: DailyTask-release-${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.commit_short }}
        path: apk_output/*release*.apk
        retention-days: 90
        if-no-files-found: warn
        
    - name: Build Summary
      run: |
        echo "## ðŸŽ‰ APK ç¼–è¯‘æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬åç§°**: ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤å“ˆå¸Œ**: ${{ steps.version.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: ${{ steps.version.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½ APK" >> $GITHUB_STEP_SUMMARY
        echo "è¯·åœ¨ä¸Šæ–¹ **Artifacts** åŒºåŸŸä¸‹è½½ç¼–è¯‘å¥½çš„ APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug APK**: ç”¨äºŽå¼€å‘è°ƒè¯•ï¼ˆåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- **Release APK**: ç”¨äºŽç”Ÿäº§å‘å¸ƒï¼ˆæœªç­¾åï¼Œéœ€è¦æ‰‹åŠ¨ç­¾åï¼‰" >> $GITHUB_STEP_SUMMARY
