name: Build and Sign APK (Fully Automated)

on:
  push:
    branches:
      - master
      - genspark_ai_developer
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Get version info
      id: version
      run: |
        # æå–ç‰ˆæœ¬ä¿¡æ¯
        VERSION_NAME=$(grep "^\s*versionName" app/build.gradle | head -1 | awk '{print $2}' | tr -d "'" | tr -d '"' | sed 's/[^0-9.]//g')
        VERSION_CODE=$(grep "^\s*versionCode" app/build.gradle | head -1 | awk '{print $2}' | sed 's/[^0-9]//g')
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date +'%Y%m%d_%H%M%S')
        
        # è®¾ç½®é»˜è®¤å€¼
        VERSION_NAME=${VERSION_NAME:-2.2.5.1}
        VERSION_CODE=${VERSION_CODE:-2251}
        
        # è¾“å‡ºå˜é‡
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        
        echo "âœ… Version Name: $VERSION_NAME"
        echo "âœ… Version Code: $VERSION_CODE"
        echo "âœ… Commit: $COMMIT_SHORT"
        echo "âœ… Build Date: $BUILD_DATE"
        
    - name: Verify Keystore
      run: |
        echo "ðŸ” Checking keystore file..."
        if [ -f "app/DailyTask.jks" ]; then
          echo "âœ… Keystore found: app/DailyTask.jks"
          ls -lh app/DailyTask.jks
        else
          echo "âŒ Keystore not found!"
          exit 1
        fi
        
    - name: Build Debug APK
      run: |
        echo "ðŸ”¨ Building Debug APK..."
        ./gradlew assembleDailyDebug --stacktrace
        
    - name: Build Release APK (Signed)
      run: |
        echo "ðŸ”¨ Building Release APK with signing..."
        ./gradlew assembleDailyRelease --stacktrace
        
    - name: Verify APK Signature
      run: |
        echo "ðŸ” Verifying APK signatures..."
        
        # æŸ¥æ‰¾ APK æ–‡ä»¶
        DEBUG_APK=$(find app/build/outputs/apk -type f -name "*.apk" -path "*/daily/debug/*" | head -n 1)
        RELEASE_APK=$(find app/build/outputs/apk -type f -name "*.apk" -path "*/daily/release/*" | head -n 1)
        
        echo "Debug APK: $DEBUG_APK"
        echo "Release APK: $RELEASE_APK"
        
        # éªŒè¯ Release APK ç­¾å
        if [ -n "$RELEASE_APK" ]; then
          echo "ðŸ“ Verifying Release APK signature..."
          jarsigner -verify -verbose -certs "$RELEASE_APK" || echo "âš ï¸ Signature verification warning (expected for V2/V3 scheme)"
          
          # ä½¿ç”¨ apksigner éªŒè¯ï¼ˆæ›´å‡†ç¡®ï¼‰
          $ANDROID_HOME/build-tools/*/apksigner verify --print-certs "$RELEASE_APK" && echo "âœ… APK is properly signed!" || echo "âŒ APK signature verification failed!"
        fi
        
    - name: Organize APK outputs
      run: |
        echo "ðŸ“¦ Organizing APK outputs..."
        mkdir -p apk_output
        
        # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„ APK
        echo "=== All APK files ==="
        find app/build/outputs/apk -type f -name "*.apk"
        
        # æŸ¥æ‰¾å¹¶å¤åˆ¶ APK
        DEBUG_APK=$(find app/build/outputs/apk -type f -name "*.apk" -path "*/daily/debug/*" | head -n 1)
        RELEASE_APK=$(find app/build/outputs/apk -type f -name "*.apk" -path "*/daily/release/*" | head -n 1)
        
        if [ -n "$DEBUG_APK" ]; then
          cp "$DEBUG_APK" "apk_output/DailyTask_${{ steps.version.outputs.version_name }}_debug_${{ steps.version.outputs.build_date }}.apk"
          echo "âœ… Debug APK copied"
          ls -lh "apk_output/DailyTask_${{ steps.version.outputs.version_name }}_debug_${{ steps.version.outputs.build_date }}.apk"
        else
          echo "âŒ Debug APK not found!"
        fi
        
        if [ -n "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" "apk_output/DailyTask_${{ steps.version.outputs.version_name }}_release_signed_${{ steps.version.outputs.build_date }}.apk"
          echo "âœ… Release APK copied (SIGNED)"
          ls -lh "apk_output/DailyTask_${{ steps.version.outputs.version_name }}_release_signed_${{ steps.version.outputs.build_date }}.apk"
        else
          echo "âŒ Release APK not found!"
        fi
        
        echo "=== Final APK outputs ==="
        ls -lh apk_output/
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: DailyTask-debug-${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.commit_short }}
        path: apk_output/*debug*.apk
        retention-days: 30
        if-no-files-found: error
        
    - name: Upload Release APK (Signed)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: DailyTask-release-signed-${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.commit_short }}
        path: apk_output/*release*.apk
        retention-days: 90
        if-no-files-found: error
        
    - name: Create Release Notes
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸŽ‰ DailyTask v${{ steps.version.outputs.version_name }} å‘å¸ƒ

        ### ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
        - **ç‰ˆæœ¬åç§°**: ${{ steps.version.outputs.version_name }}
        - **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}
        - **æäº¤å“ˆå¸Œ**: ${{ steps.version.outputs.commit_short }}
        - **æž„å»ºæ—¶é—´**: ${{ steps.version.outputs.build_date }}

        ### âœ¨ æ ¸å¿ƒåŠŸèƒ½
        - âœ… é’‰é’‰è‡ªåŠ¨æ‰“å¡
        - âœ… ä¼ªç­å±æŽ§åˆ¶ï¼ˆé˜²æ­¢çœŸæ­£ç†„å±ï¼‰
        - âœ… è¿œç¨‹æŒ‡ä»¤æŽ§åˆ¶
        - âœ… æ‰‹åŠ¨éŸ³é‡é”®åˆ‡æ¢
        - âœ… **å‘¨æœ«/èŠ‚å‡æ—¥è‡ªåŠ¨æš‚åœæ‰“å¡**ï¼ˆå†…ç½® 2026 å¹´èŠ‚å‡æ—¥æ•°æ®ï¼‰
        - âœ… **æ‰“å¡å®ŒæˆåŽè‡ªåŠ¨æ¢å¤æš—è‰²**ï¼ˆ10-30 ç§’éšæœºå»¶è¿Ÿï¼‰

        ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
        - **Debug APK**: åŒ…å«è°ƒè¯•ä¿¡æ¯ï¼Œé€‚åˆæµ‹è¯•
        - **Release APK**: å·²ç­¾åï¼Œå¯ç›´æŽ¥å®‰è£…ä½¿ç”¨ âœ…

        ### ðŸ”’ ç­¾åä¿¡æ¯
        - æ‰€æœ‰ Release APK å‡å·²ä½¿ç”¨å®˜æ–¹å¯†é’¥ç­¾å
        - å¯ä»¥æ”¾å¿ƒå®‰è£…ä½¿ç”¨

        ### ðŸ“š ç›¸å…³æ–‡æ¡£
        - [å®Œæ•´äº¤ä»˜æŠ¥å‘Š](https://github.com/xiaohuai3344/DailyTask-master3344/blob/master/COMPLETE_DELIVERY_REPORT.md)
        - [åŠŸèƒ½ä½¿ç”¨è¯´æ˜Ž](https://github.com/xiaohuai3344/DailyTask-master3344/blob/master/WEEKEND_HOLIDAY_USAGE.md)

        ---
        
        **æ³¨æ„**: é¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦å…è®¸"å®‰è£…æœªçŸ¥åº”ç”¨"æƒé™
        EOF
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          apk_output/DailyTask_${{ steps.version.outputs.version_name }}_debug_${{ steps.version.outputs.build_date }}.apk
          apk_output/DailyTask_${{ steps.version.outputs.version_name }}_release_signed_${{ steps.version.outputs.build_date }}.apk
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸŽ‰ APK æž„å»ºå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬åç§°**: ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤å“ˆå¸Œ**: ${{ steps.version.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: ${{ steps.version.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… ç­¾åçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug APK**: ä½¿ç”¨ Debug å¯†é’¥ç­¾å" >> $GITHUB_STEP_SUMMARY
        echo "- **Release APK**: âœ… å·²ä½¿ç”¨å®˜æ–¹å¯†é’¥ç­¾å" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½ APK" >> $GITHUB_STEP_SUMMARY
        echo "è¯·åœ¨ä¸Šæ–¹ **Artifacts** åŒºåŸŸä¸‹è½½ç¼–è¯‘å¥½çš„ APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug APK**: åŒ…å«è°ƒè¯•ä¿¡æ¯ï¼Œé€‚åˆå¼€å‘æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- **Release APK**: å·²ç­¾åï¼Œå¯ç›´æŽ¥å®‰è£…ä½¿ç”¨ âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ å®‰è£…è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½å¯¹åº”çš„ APK æ–‡ä»¶ï¼ˆæŽ¨è Release ç‰ˆæœ¬ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "2. åœ¨æ‰‹æœºä¸Šå…è®¸"å®‰è£…æœªçŸ¥åº”ç”¨"æƒé™" >> $GITHUB_STEP_SUMMARY
        echo "3. ç›´æŽ¥å®‰è£…å³å¯ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
