name: Build, Sign and Release APK

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Get version info
      id: version
      run: |
        # æå–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆæ›´ç²¾ç¡®çš„åŒ¹é…ï¼Œé¿å…åŒ¹é…åˆ°å…¶ä»–è¡Œï¼‰
        VERSION_NAME=$(grep "^\s*versionName" app/build.gradle | head -1 | awk '{print $2}' | tr -d "'" | tr -d '"')
        VERSION_CODE=$(grep "^\s*versionCode" app/build.gradle | head -1 | awk '{print $2}')
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date +'%Y%m%d_%H%M%S')
        
        # éªŒè¯æå–çš„å€¼ä¸ä¸ºç©ºä¸”æ ¼å¼æ­£ç¡®
        if [ -z "$VERSION_NAME" ] || [[ "$VERSION_NAME" == *"+"* ]] || [[ "$VERSION_NAME" == *"="* ]]; then
          VERSION_NAME="2.2.5.1"
          echo "Warning: Could not extract versionName correctly, using default: $VERSION_NAME"
        fi
        if [ -z "$VERSION_CODE" ] || [[ "$VERSION_CODE" == *"+"* ]] || [[ "$VERSION_CODE" == *"="* ]]; then
          VERSION_CODE="2251"
          echo "Warning: Could not extract versionCode correctly, using default: $VERSION_CODE"
        fi
        
        # æ¸…ç†å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
        VERSION_NAME=$(echo "$VERSION_NAME" | sed 's/[^0-9.]//g')
        VERSION_CODE=$(echo "$VERSION_CODE" | sed 's/[^0-9]//g')
        
        # æ‰“å°è°ƒè¯•ä¿¡æ¯
        echo "Extracted Version Name: $VERSION_NAME"
        echo "Extracted Version Code: $VERSION_CODE"
        echo "Commit: $COMMIT_SHORT"
        echo "Build Date: $BUILD_DATE"
        
        # è¾“å‡ºåˆ° GitHub Actionsï¼ˆç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
        echo "version_name=$VERSION_NAME" >> "$GITHUB_OUTPUT"
        echo "version_code=$VERSION_CODE" >> "$GITHUB_OUTPUT"
        echo "commit_short=$COMMIT_SHORT" >> "$GITHUB_OUTPUT"
        echo "build_date=$BUILD_DATE" >> "$GITHUB_OUTPUT"
        
    - name: Decode Keystore
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.jks
        echo "Keystore decoded successfully"
        
    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace
      
    - name: Build Release APK (Signed)
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=${{ github.workspace }}/app/release.jks \
          -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
          --stacktrace
        
    - name: Organize APK files
      run: |
        # åˆ—å‡º APK è¾“å‡ºç›®å½•ç»“æž„
        echo "=== APK Output Directory Structure ==="
        find app/build/outputs/apk -type f -name "*.apk"
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p apk_output
        
        # æŸ¥æ‰¾å¹¶å¤åˆ¶ Debug APK
        DEBUG_APK=$(find app/build/outputs/apk -type f -name "*.apk" -path "*/debug/*" | head -n 1)
        if [ -n "$DEBUG_APK" ]; then
          cp "$DEBUG_APK" "apk_output/DailyTask_${{ steps.version.outputs.version_name }}_debug_${{ steps.version.outputs.build_date }}.apk"
          echo "âœ“ Debug APK: $(ls -lh apk_output/*debug*.apk | awk '{print $5}')"
        fi
        
        # æŸ¥æ‰¾å¹¶å¤åˆ¶ Release APKï¼ˆå·²ç­¾åï¼‰
        RELEASE_APK=$(find app/build/outputs/apk -type f -name "*.apk" -path "*/release/*" | head -n 1)
        if [ -n "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" "apk_output/DailyTask_${{ steps.version.outputs.version_name }}_release_${{ steps.version.outputs.build_date }}.apk"
          echo "âœ“ Release APK: $(ls -lh apk_output/*release*.apk | awk '{print $5}')"
        fi
        
        # æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶
        echo "=== Final APK files ==="
        ls -lh apk_output/
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: DailyTask-debug-${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.commit_short }}
        path: apk_output/*debug*.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload Release APK (Signed)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: DailyTask-release-${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.commit_short }}
        path: apk_output/*release*.apk
        retention-days: 90
        if-no-files-found: warn
        
    - name: Create Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸŽ‰ DailyTask v${{ steps.version.outputs.version_name }} å‘å¸ƒ

        ### ðŸ“¦ æž„å»ºä¿¡æ¯
        - **ç‰ˆæœ¬å·**: ${{ steps.version.outputs.version_name }}
        - **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}
        - **æž„å»ºæ—¥æœŸ**: ${{ steps.version.outputs.build_date }}
        - **æäº¤å“ˆå¸Œ**: ${{ steps.version.outputs.commit_short }}

        ### âœ¨ æ ¸å¿ƒåŠŸèƒ½
        - âœ… é’‰é’‰è‡ªåŠ¨æ‰“å¡
        - âœ… ä¼ªç­å±æŽ§åˆ¶ï¼ˆæš—è‰²é®ç½©ï¼‰
        - âœ… è¿œç¨‹æŒ‡ä»¤æŽ§åˆ¶ï¼ˆæ¯å±/äº®å±ï¼‰
        - âœ… æ‰‹åŠ¨éŸ³é‡é”®åˆ‡æ¢
        - âœ… **å‘¨æœ«è‡ªåŠ¨æš‚åœæ‰“å¡**ï¼ˆæ–°åŠŸèƒ½ï¼‰
        - âœ… **èŠ‚å‡æ—¥è‡ªåŠ¨æš‚åœæ‰“å¡**ï¼ˆæ–°åŠŸèƒ½ï¼Œå†…ç½® 2026 å¹´æ•°æ®ï¼‰
        - âœ… **æ‰“å¡å®Œæˆè‡ªåŠ¨æ¢å¤æš—è‰²**ï¼ˆæ–°åŠŸèƒ½ï¼Œ10-30 ç§’éšæœºå»¶è¿Ÿï¼‰
        - âœ… Bugly å¼‚å¸¸æ—¥å¿—è®°å½•

        ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
        - **DailyTask_xxx_debug.apk**: Debug ç‰ˆæœ¬ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼ŒæŽ¨èæµ‹è¯•ä½¿ç”¨
        - **DailyTask_xxx_release.apk**: Release ç‰ˆæœ¬ï¼Œå·²ç­¾åä¼˜åŒ–ï¼ŒæŽ¨èç”Ÿäº§ä½¿ç”¨

        ### ðŸ“± å®‰è£…è¦æ±‚
        - Android 7.0 (API 26) æˆ–æ›´é«˜ç‰ˆæœ¬
        - éœ€è¦æŽˆäºˆé€šçŸ¥æƒé™å’Œæ‚¬æµ®çª—æƒé™

        ### ðŸ§ª æµ‹è¯•å»ºè®®
        1. æµ‹è¯•å‘¨æœ«/èŠ‚å‡æ—¥è‡ªåŠ¨æš‚åœåŠŸèƒ½
        2. æµ‹è¯•æ‰“å¡å®Œæˆè‡ªåŠ¨æ¢å¤æš—è‰²åŠŸèƒ½
        3. æµ‹è¯•è¿œç¨‹æŒ‡ä»¤å’Œæ‰‹åŠ¨åˆ‡æ¢å…¼å®¹æ€§

        ### ðŸ“š å®Œæ•´æ–‡æ¡£
        æŸ¥çœ‹è¯¦ç»†åŠŸèƒ½è¯´æ˜Žå’Œæµ‹è¯•æŒ‡å—ï¼Œè¯·è®¿é—®ä»“åº“ä¸­çš„ `COMPLETE_DELIVERY_REPORT.md`
        EOF
        
        echo "Release notes created"
        cat release_notes.md
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          apk_output/*.apk
        body_path: release_notes.md
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Summary
      run: |
        echo "## ðŸŽ‰ APK ç¼–è¯‘æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬åç§°**: ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬ä»£ç **: ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤å“ˆå¸Œ**: ${{ steps.version.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: ${{ steps.version.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½ APK" >> $GITHUB_STEP_SUMMARY
        echo "è¯·åœ¨ä¸Šæ–¹ **Artifacts** åŒºåŸŸä¸‹è½½ç¼–è¯‘å¥½çš„ APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug APK**: ç”¨äºŽå¼€å‘è°ƒè¯•ï¼ˆåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- **Release APK**: å·²ç­¾åä¼˜åŒ–ï¼Œç”¨äºŽç”Ÿäº§å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          echo "### ðŸš€ GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "å·²è‡ªåŠ¨åˆ›å»º GitHub Releaseï¼Œå¯åœ¨ Releases é¡µé¢ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        fi
